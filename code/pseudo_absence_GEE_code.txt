var table = ee.FeatureCollection('ae_points');    // switch to al_points for AL
var b1 = ee.Image('ae_tempsuit');                 // switch to al_tempsuit for AL temperature suitability
var seaMaskImg = ee.Image('sea_mask');            // SEA mask raster

b1 = b1.updateMask(seaMaskImg);

var Terrain = ee.Algorithms.Terrain(ee.Image('USGS/SRTMGL1_003'));
var landMask = Terrain.select('elevation').gt(0);
b1 = b1.updateMask(landMask);

var AOI = seaMaskImg.geometry();

var stats = b1.reduceRegion({
  reducer: ee.Reducer.mean().combine({
    reducer2: ee.Reducer.stdDev(),
    sharedInputs: true
  }),
  geometry: AOI,
  scale: 1000,
  maxPixels: 1e13,
  bestEffort: true
});

var mean_b1 = ee.Number(stats.get('b1_mean'));
var std_b1  = ee.Number(stats.get('b1_stdDev'));
var z_b1 = b1.subtract(mean_b1).divide(std_b1);

var zThr = -1;
var maskRaster = z_b1.lt(zThr).selfMask();

var cellSize = 4000;

var dedup = function (fc) {
  var rnd = ee.Image.random().reproject('EPSG:4326', null, cellSize);
  var sampled = rnd.sampleRegions({
    collection: ee.FeatureCollection(fc),
    scale: 500,
    geometries: true
  });
  return sampled.distinct('random').map(function (f) {
    return ee.Feature(f.geometry()).copyProperties(f);
  });
};

var presence = dedup(table)
  .filterBounds(seaMaskImg.geometry())
  .map(function (f) { return f.set('PresAbs', 1); });

var targetN = presence.size();

var candidates = maskRaster.addBands(ee.Image.random().rename('rand'))
  .sample({
    region: seaMaskImg.geometry(),
    scale: cellSize,
    numPixels: targetN.multiply(30),
    geometries: true,
    tileScale: 4
  })
  .sort('rand')
  .limit(targetN);

var pseudoAbs = ee.FeatureCollection(candidates).map(function (f) {
  return ee.Feature(f.geometry()).set('PresAbs', 0);
});

var merged = presence.merge(pseudoAbs);

var exportFC = merged.map(function (f) {
  var coords = f.geometry().transform('EPSG:4326').coordinates();
  return f.set('lon', coords.get(0)).set('lat', coords.get(1)).setGeometry(null);
});

Export.table.toDrive({
  collection: exportFC,
  description: 'pseudo_absence',
  fileFormat: 'CSV'
});
